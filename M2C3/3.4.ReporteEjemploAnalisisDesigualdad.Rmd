---
title: "Análisis de la desigualdad en el mundo"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, float = FALSE)
```

```{r Cargar librerías}
# Cargar librerías
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)
library(stargazer)
library(DT)
```

```{r Cargar datos}
# Cargar planilla "maestra" con los datos de interés
data <- 
  # Cargar planilla de datos (.csv)
  read_csv("Datos/WDIData.csv") 

# Cargar planilla complementaria
paises <- read_csv("Datos/WDICountry.csv") %>% 
  # Dejar solo países y no regiones (por ej, Latin America)
  filter(!is.na(`Income Group`)) 
```

```{r Manejo de datos}
datos <- data %>% 
  # Seleccionar algunos indicadores
  filter(`Indicator Name` %in% c("Government expenditure on education, total (% of GDP)",
                                 "GINI index (World Bank estimate)",
                                 "Unemployment, total (% of total labor force) (modeled ILO estimate)",
                                 "Research and development expenditure (% of GDP)",
                                 "Military expenditure (% of GDP)",
                                 "GDP per capita, PPP (current international $)"
  )) %>% 
  
  # Dejar solo observaciones que corresponden a países y no a regiones (por ej, Latin America)
  filter(`Country Name` %in% paises$`Table Name`) %>% 
  
  # Cambiar la forma de los datos de "ancho" a "largo"
  pivot_longer("2012":"2018", names_to = "Year", values_to = "Value") %>% 
  
  # Imputación: rellenar valores NA de indicadores cuando se pueda
  group_by(`Country Name`, `Indicator Name`) %>% 
  fill(Value, .direction = "downup") %>% 
  ungroup() %>% 

  # Agregar columna con información sobre nivel de ingresos y regiónde cada país
  left_join(select(paises, `Table Name`, `Income Group`, Region), by = c("Country Name" = "Table Name")) %>% 
  
  # Sacar columnas que no serán utilizadas
  select(-`Indicator Code`, -`Country Code`) %>% 
  
  # Cambiar nombres de variables a español
  rename("pais" = "Country Name",
         "indicador" = "Indicator Name",
         "anio" = "Year",
         "valor" = "Value",
         "grupo_ingresos" = "Income Group",
         "region" = "Region") %>% 

  # Cambiar nombres de "indicador", region, y grupo de ingresos a español
  mutate(indicador = case_when(
                            indicador == "GDP per capita, PPP (current international $)" ~ "pib_percapita",
                            indicador == "GINI index (World Bank estimate)" ~ "gini",
                            indicador == "Government expenditure on education, total (% of GDP)" ~ "gasto_educacion",
                            indicador == "Military expenditure (% of GDP)"  ~ "gasto_militar",
                            indicador == "Research and development expenditure (% of GDP)" ~ "gasto_ID",
                            indicador == "Unemployment, total (% of total labor force) (modeled ILO estimate)" ~ "desempleo"
                            ),
         region = case_when(
                         region == "South Asia" ~ "Asia del Sur",
                         region == "Europe & Central Asia" ~ "Europa y Asia Central",
                         region == "Middle East & North Africa" ~ "Medio Este y Africa del Norte",
                         region == "East Asia & Pacific" ~ "Asia del Este y Pacífico",
                         region == "Sub-Saharan Africa" ~ "Africa Subsahariana",
                         region == "Latin America & Caribbean" ~ "Latinoamérica y el Caribe",
                         region == "North America" ~ "América del Norte"
                         ),
         grupo_ingresos = case_when(
                                 grupo_ingresos == "Low income" ~ "Ingreso Bajo",
                                 grupo_ingresos == "Lower middle income" ~ "Ingreso Medio-Bajo",
                                 grupo_ingresos == "Upper middle income" ~ "Ingreso Medio-Alto",
                                 grupo_ingresos == "High income" ~ "Ingreso Alto"
                                 )) %>% 
  
  # Cambiar tipo de variables 
  mutate(
    pais = as.factor(pais),
    grupo_ingresos = as.factor(grupo_ingresos),
    anio = as.numeric(anio)
  ) %>% 
  
  # Transformar los valores de la columna "indicador" a sus propias columnas
  pivot_wider(names_from = indicador, values_from = valor)
```

## Sobre el documento

En el siguiente documento haremos un breve análisis sobre la desigualdad en el mundo (medida a través del **coeficiente de GINI**). Los datos utilizados provienen del sitio web de indicadores del [Banco Mundial](https://data.worldbank.org/indicator).

## Descripción de desigualdad a nivel regional y país

En primer lugar analizaremos como se comporta la desigualdad en el periódo estudiado (2012-2018) para las distintas regiones del mundo. *Cabe mencionar que a menor coeficiente GINI, menor desigualdad*.

```{r Gráfico GINI por región, fig.width=7, fig.height=5, fig.align="center"}
datos_graf_1 <- 
  # datos generados inicialmente
  datos %>% 
  # agrupar los datos por región y año
  group_by(region, anio) %>% 
  # para cada año y región calcular el promedio del coeficiente GINI
  summarise(gini = round(mean(gini, na.rm = TRUE), 1)) %>% 
  ungroup()

datos_graf_1 %>% 
  # gráfico de año vs gini para cada región
  ggplot(aes(x = anio, y = gini, group = region, color = region)) +
  # gráfico de linea (se creará una linea para cada región)
  geom_line(size = 1.5) + 
  # detalles estéticos del gráfico
  theme_bw() + 
  labs(y = "Coeficiente GINI") + 
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

max_valor <- datos_graf_1 %>% 
  arrange(-gini) %>% 
  slice(1)
min_valor <- datos_graf_1 %>% 
  arrange(gini) %>% 
  slice(1)
```

En el gráfico se puede percibir que la desigualdad tiende a mantenerse constante en el periódo estudiado, destacando **Latinoamérica y el Caribe** como la región más desigual pero la que pareciera tener la mayor disminución. El máximo valor corresponde a `r pull(max_valor, region)` el año `r pull(max_valor, anio)` mientras que el menor valor corresponde a `r pull(min_valor, region)` el año `r pull(min_valor, anio)`.

Considerando que `r pull(max_valor, region)` es la región con mayor desigualdad, haremos un *zoom* en los países que lo componen. El siguiente gráfico muestra el coeficiente GINI para cada uno de los países de la región en el último año disponible.

```{r GINI LATAM y Caribe, fig.width=7.5, fig.height=5, fig.align="center"}
datos_graf_2 <- 
  # datos generados inicialmente
  datos %>% 
  # sacar observaciones (filas) con valores nulos y solo dejar aquellas correspondiente a países de la región con mayor coeficiente GINI y para el ultimo año disponible
  filter(region == pull(max_valor, region), !is.na(gini), anio == max(pull(datos, anio))) 

datos_graf_2 %>% 
  # gráfico de pais vs gini
  ggplot(aes(x = reorder(pais, gini), y = gini, label = gini)) + 
  # gráfico de columna
  geom_col(fill = "light blue") + 
  # columnas horizontales 
  coord_flip() + 
  # Agregar texto correspondiente al valor de GINI para cada país
  geom_text(nudge_y = 1.7, size = 3) +
  # detalles estéticos del gráfico
  theme_bw() +
  labs(x = "",
       y = "")
```

La siguiente tabla resume para los países de `r pull(max_valor, region)` el cambio en el coeficiente de GINI durante los últimos años:

```{r}
datos %>% 
  # sacar observaciones (filas) con valores nulos y solo dejar aquellas correspondiente a países de la región con mayor coeficiente GINI
  filter(region == pull(max_valor, region), !is.na(gini)) %>% 
  
  # seleccionamos columnas de interés
  select(pais, anio, gini) %>% 
  
  # le damos forma  la tabla
  pivot_wider(names_from = anio, values_from = gini) %>% 
  datatable()
```


## Análisis estadístico

A continuación, estimaremos algunos modelos para ver si podemos aprender algo más sobre la desigualdad a nivel mundial para el periodo 2012-2018. Para esto, estimaremos -para todo país $i$ y año $j$- los siguientes modelos:

- (1) $GINI_{i,j} = PIBpercapita_{i,j} + GrupoIngresos_{i,j} + Region_{i} + Año_{j}$

- (2) $GINI_{i,j} = PIBpercapita_{i,j} + GastoEducacion_{i,j} + Desempleo_{i,j} + GrupoIngresos_{i,j} + Region_{i} + Año_{j}$

- (3) $GINI_{i,j} = PIBpercapita_{i,j} + GastoEducacion_{i,j} + Desempleo_{i,j} + GastoMilitar_{i,j} + GastoI\&D_{i,j}+ GrupoIngresos_{i,j} + Region_{i} + Año_{j}$

```{r}
reg1 <- lm(gini ~ pib_percapita + grupo_ingresos + region + anio, data = datos)

reg2 <- lm(gini ~ pib_percapita + gasto_educacion + desempleo + grupo_ingresos + region + anio, data = datos) 

reg3 <- lm(gini ~ pib_percapita + gasto_educacion + desempleo + gasto_militar + gasto_ID + grupo_ingresos + region + anio, data = datos) 
```

Los resultados de los modelos (tablas de regresión) se pueden ver a continuación. 

<div align="center">
```{r, results='asis'}
stargazer(reg1, reg2, reg3, type = "html")
``` 
</div>

Los modelos estimados parecieran no ser muy concluyentes, lo más consistente es que a medida que los países tienen mayor desempleo también aumenta el nivel de desigualdad. Sería interesante poder incluir otras variables para tratar de explicar de mejor manera la desigualdad a nivel país.